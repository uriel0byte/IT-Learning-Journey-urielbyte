# Day 6: Malware Analysis - Egg-xecutable

## üìã Quick Facts
- **Date Completed:** December 6, 2025
- **Time Spent:** 2 hours
- **Difficulty:** ‚òÖ‚òÖ‚òÖ‚òÜ (Hard)
- **Category:** Malware Analysis / Digital Forensics
- **Room URL:** https://tryhackme.com/room/malware-sandbox-aoc2025-SD1zn4fZQt

---

## üéØ Challenge Overview

This challenge introduced malware analysis fundamentals through investigating a suspicious executable (`HopHelper.exe`) received via email at 3AM from Elf McClause. As Elf McBlue, I used static and dynamic malware analysis techniques to examine the sample without executing it initially, then safely analyzed its behavior in a sandbox environment. The investigation revealed persistence mechanisms, network communications, and command-and-control infrastructure.

**Learning Objectives:**
- Learn the principles of malware analysis
- Understand sandboxes and safe malware investigation environments
- Differentiate between static vs. dynamic analysis
- Use industry tools: PeStudio, ProcMon (Process Monitor), Regshot

---

## üí° What I Learned

### The Golden Rule of Malware Analysis

**NEVER run dangerous applications on devices you care about.**

Always use **sandboxes**‚Äîsafe, isolated environments (usually virtual machines) where malicious code can execute without risking sensitive data or other systems. Sandboxes allow you to:
- Control how the system operates
- Use **snapshots** to save and restore system states
- Safely observe malware behavior in isolation

### Two Branches of Malware Analysis

**Static Analysis:**
- Examine a file **WITHOUT executing it**
- Gather information about how the sample *may* operate
- Quick and effective for initial triage
- Identify samples through checksums, strings, imports, resources

**Dynamic Analysis:**
- Execute the malware in a controlled environment
- Observe **actual behavior** and system interactions
- See registry changes, file creation, network connections
- Understand *exactly* what the malware does

**Important:** Attackers use **obfuscation** to hide malware functionality and evade antivirus/analysts. You don't truly know what malware does until it's executed (hence dynamic analysis).

### Static Analysis Techniques

Using **PeStudio** to examine `HopHelper.exe` without execution:

**1. Checksums (SHA256)**
- Unique identifier for the executable
- Used for threat intelligence and tracking known malware
- Can Google the checksum to see if previously identified

**2. Strings**
- Readable text sequences within the executable
- Can reveal: IP addresses, URLs, commands, passwords, flags
- Example: `138.62.51.186` found in strings ‚Üí potential C2 server

**3. Imports**
- Libraries and functions the application depends on
- Shows how malware interacts with the operating system
- Example: `CreateFile` ‚Üí malware creates files on the system

**4. Resources**
- Data like icons displayed to users
- Malware may disguise itself (e.g., Word document icon)
- Malware payloads sometimes hidden in resource sections

### Dynamic Analysis Techniques

**1. Regshot (Registry Monitoring)**

Regshot creates "before" and "after" snapshots of the Windows Registry to identify changes:

**Workflow:**
1. Take **1st snapshot** before executing malware
2. Execute the malware sample
3. Take **2nd snapshot** after execution
4. **Compare** differences to see registry modifications

**Why it matters:** Malware establishes **persistence** by adding `Run` keys to the registry, ensuring it executes automatically when the system boots.

**2. Process Monitor (ProcMon) - Sysinternals**

ProcMon monitors how processes interact with Windows in real-time:

**What it captures:**
- Registry key reads/writes (`RegOpenKey`)
- File creation/access (`CreateFile`)
- Network connections (`TCP Connect`, `TCP Receive`)
- Process behavior and system calls

**Filtering ProcMon:**
Because ProcMon captures *everything*, filtering is essential:
- Filter by **Process Name** (e.g., `HopHelper.exe`)
- Filter by **Operation** (e.g., `TCP` for network activity)
- Remove noise from system processes

**Key Operations to investigate:**
- `RegOpenKey` - Registry access
- `CreateFile` - File system changes
- `TCP Connect` - Network communications
- `TCP Receive` - Data received from network

### What I Discovered About HopHelper.exe

Through static and dynamic analysis:

**Static findings:**
- SHA256 checksum identified
- Strings revealed embedded flags and potential C2 infrastructure
- Imports showed Windows API usage

**Dynamic findings:**
- **Registry persistence** - Modified registry key for automatic execution
- **Network protocol** - Used TCP for communication
- **Command-and-Control (C2)** - Communicated with external web panel (bonus finding)

---

## üõ†Ô∏è Tools & Techniques Used

### Tools
1. **PeStudio** - Static analysis tool for examining executables without execution
2. **Regshot** - Registry snapshot comparison utility
3. **Process Monitor (ProcMon)** - Real-time process monitoring (Sysinternals)
4. **Virtual Machine Sandbox** - Safe, isolated malware execution environment

### Techniques
- **Static analysis:** Checksum identification, string extraction, import analysis, resource examination
- **Dynamic analysis:** Registry change detection, process behavior monitoring, network traffic observation
- **Sandbox methodology:** Snapshot creation, safe malware execution, system restoration
- **Filtering:** Removing noise from ProcMon output to focus on malware behavior
- **Threat intelligence:** Using checksums to identify known malware samples

---

## ü§î Challenges I Faced

**Understanding New Concepts:** This was like entering a whole new world. Malware analysis introduced completely new concepts and terminology that were unfamiliar and hard to grasp initially.

**Tool Complexity:** Programs like PeStudio and ProcMon have lots of fields and information displayed. Most of the things I saw in these programs, I didn't fully understand even after reading the instructions. The sheer amount of data was overwhelming.

**Following vs. Understanding:** I had no problem following the instructions to perform certain tasks (take snapshots, apply filters, extract strings), but *understanding* what I was actually doing and why it mattered was challenging. It felt like going through the motions without full comprehension.

**Information Overload:** ProcMon especially showed thousands of events. Even with filters, distinguishing important behavior from noise was confusing. Understanding which registry keys or operations were significant required context I didn't fully have.

**It's Hard and Confusing:** Overall, malware analysis is hard and confusing when you're just starting. The technical depth, unfamiliar Windows internals (registry, imports, resources), and the methodology itself all felt complex and intimidating.

---

## ‚úÖ How This Helps My Career

Despite the difficulty, **malware analysis is essential for SOC analysts and incident responders**:

**Why Malware Analysis Matters:**
- **60% of SOC analyst job postings** mention malware detection/analysis skills
- Malware is the #1 delivery mechanism for data breaches and ransomware
- Understanding malware behavior helps with alert triage and incident response

**SOC Analyst Applications:**

**Alert Triage:**
- Investigate suspicious executables flagged by EDR (Endpoint Detection & Response)
- Determine if a file is malicious or benign (false positive reduction)
- Extract IOCs (Indicators of Compromise) like checksums, IPs, URLs

**Incident Response:**
- Analyze persistence mechanisms to ensure complete malware removal
- Identify C2 infrastructure for network blocking/monitoring
- Understand attack timeline and scope of compromise

**Threat Hunting:**
- Use checksums (SHA256) to search for known malware across endpoints
- Hunt for registry persistence keys added by malware
- Identify lateral movement and post-exploitation activities

**Defensive Measures:**
- Block malicious IPs/domains discovered through analysis
- Create detection rules based on malware behavior (registry changes, network patterns)
- Update threat intelligence feeds with newly discovered samples

**Career Skills Developed:**
- **Windows internals understanding** (registry, processes, system calls)
- **Forensic analysis mindset** (before/after comparison, behavior observation)
- **Tool proficiency** (Sysinternals suite is industry-standard)
- **Safe investigation practices** (sandbox methodology, golden rule)

**Interview Talking Point:** "I have hands-on experience with static and dynamic malware analysis using industry tools like PeStudio, Process Monitor, and Regshot. I can safely execute suspicious samples in sandbox environments, identify persistence mechanisms through registry analysis, monitor process behavior, and extract IOCs like network infrastructure and file checksums for threat intelligence and defensive blocking."

---

## üîó Security+ Connection

**Domain 2.0 - Threats, Vulnerabilities & Mitigations (22%):** Malware types, attack techniques, indicators of compromise, threat intelligence.

**Domain 4.0 - Security Operations (28%):** Incident response, forensic analysis, malware detection, monitoring and logging, threat hunting methodologies.

---

## üì∏ Evidence

![PeStudio Static Analysis](../07-Screenshots/day-06/pestudio-sha256-strings.png)
*Used PeStudio to extract SHA256 checksum and strings from HopHelper.exe without executing it*

![Regshot Registry Comparison](../07-Screenshots/day-06/regshot-before-after.png)
*Regshot comparison revealing registry persistence key added by HopHelper.exe for automatic execution*

![Process Monitor Filtering](../07-Screenshots/day-06/procmon-tcp-filter.png)
*Filtered Process Monitor for TCP operations to identify network protocol used by HopHelper.exe for C2 communication*
